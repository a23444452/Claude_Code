name: ğŸ”’ Security Scan

on:
  pull_request:
    branches: [main, develop]
    paths:
      - '**.py'
      - 'requirements.txt'
  push:
    branches: [main]
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety pip-audit

    - name: ğŸ” Run Bandit security linter
      run: |
        echo "ğŸ” Scanning for security issues in Python code..."
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ -f txt || echo "âš ï¸ Security issues found, check report"

    - name: ğŸ” Check dependencies for vulnerabilities
      run: |
        echo "ğŸ” Checking dependencies for known vulnerabilities..."
        if [ -f requirements.txt ]; then
          pip-audit -r requirements.txt || echo "âš ï¸ Vulnerable dependencies found"
        fi

    - name: ğŸ” Check for hardcoded secrets
      run: |
        echo "ğŸ” Checking for hardcoded secrets and credentials..."
        if grep -rn -E '(password|secret|api_key|token|aws_access_key_id|private_key)\s*=\s*["\047][^"\047]{8,}["\047]' src/ --include="*.py"; then
          echo "âŒ Potential hardcoded secrets found!"
          echo "Please remove hardcoded credentials and use environment variables."
          exit 1
        fi
        echo "âœ… No hardcoded secrets found"

    - name: ğŸ” Check for common security issues
      run: |
        echo "ğŸ” Checking for common security issues..."
        issues_found=0

        # Check for eval() usage
        if grep -rn 'eval(' src/ --include="*.py"; then
          echo "âš ï¸ Warning: Found eval() usage - potential security risk"
          issues_found=1
        fi

        # Check for exec() usage
        if grep -rn 'exec(' src/ --include="*.py"; then
          echo "âš ï¸ Warning: Found exec() usage - potential security risk"
          issues_found=1
        fi

        # Check for pickle usage
        if grep -rn 'import pickle' src/ --include="*.py"; then
          echo "âš ï¸ Warning: Found pickle usage - can be unsafe with untrusted data"
          issues_found=1
        fi

        # Check for shell=True in subprocess
        if grep -rn 'shell=True' src/ --include="*.py"; then
          echo "âš ï¸ Warning: Found shell=True in subprocess - potential command injection risk"
          issues_found=1
        fi

        if [ $issues_found -eq 0 ]; then
          echo "âœ… No common security issues found"
        fi

    - name: ğŸ“Š Upload Bandit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-report
        path: bandit-report.json

    - name: âœ… Security scan completed
      run: echo "âœ… Security scan completed! Check artifacts for detailed reports."
