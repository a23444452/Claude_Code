name: ğŸš« Validate Commit Contents

on:
  pull_request:
    branches: [main, develop]

jobs:
  validate-commit:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for all branches

    - name: ğŸ” Check for model files (.pt)
      run: |
        echo "ğŸ” Checking for model weight files..."
        if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E '\.pt$'; then
          echo "âŒ Error: Found .pt model files in commit!"
          echo "Please remove model files from your commit."
          echo "Model files should be stored in cloud storage or DVC, not in Git."
          exit 1
        fi
        echo "âœ… No model files found"

    - name: ğŸ” Check for dataset files
      run: |
        echo "ğŸ” Checking for dataset files..."
        if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E '^dataset/.*\.(jpg|jpeg|png|txt)$'; then
          echo "âŒ Error: Found dataset files in commit!"
          echo "Please remove dataset images/annotations from your commit."
          echo "Datasets should be managed separately, not in Git."
          exit 1
        fi
        echo "âœ… No dataset files found"

    - name: ğŸ” Check for config files with sensitive data
      run: |
        echo "ğŸ” Checking for config files..."
        if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E '^config/.*\.yaml$' | grep -v '\.example\.yaml$'; then
          echo "âŒ Error: Found config files in commit!"
          echo "Please only commit .example.yaml files, not actual config files."
          echo "Config files may contain local paths or sensitive information."
          exit 1
        fi
        echo "âœ… No sensitive config files found"

    - name: ğŸ” Check for large files
      run: |
        echo "ğŸ” Checking for large files (>10MB)..."
        large_files=$(git diff --name-only origin/${{ github.base_ref }}..HEAD | while read file; do
          if [ -f "$file" ]; then
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
            if [ "$size" -gt 10485760 ]; then
              echo "$file ($(numfmt --to=iec-i --suffix=B $size 2>/dev/null || echo ${size}B))"
            fi
          fi
        done)
        if [ -n "$large_files" ]; then
          echo "âŒ Error: Found large files in commit:"
          echo "$large_files"
          echo "Please remove large files and use Git LFS or cloud storage instead."
          exit 1
        fi
        echo "âœ… No large files found"

    - name: ğŸ” Check for sensitive files
      run: |
        echo "ğŸ” Checking for sensitive files..."
        if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E '\.(env|pem|key|p12|pfx)$'; then
          echo "âŒ Error: Found sensitive files in commit!"
          echo "Please remove .env files, private keys, and certificates from your commit."
          exit 1
        fi
        echo "âœ… No sensitive files found"

    - name: ğŸ” Check commit message format
      run: |
        echo "ğŸ” Checking commit message format..."
        # Get commit messages from this PR
        commits=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s")
        invalid_commits=""

        while IFS= read -r msg; do
          # Check if commit follows Conventional Commits format
          if ! echo "$msg" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
            invalid_commits="${invalid_commits}\n- ${msg}"
          fi
        done <<< "$commits"

        if [ -n "$invalid_commits" ]; then
          echo "âš ï¸ Warning: Some commits don't follow Conventional Commits format:"
          echo -e "$invalid_commits"
          echo ""
          echo "Format: <type>(<scope>): <subject>"
          echo "Example: feat(api): add batch prediction endpoint"
        else
          echo "âœ… All commit messages follow Conventional Commits format"
        fi

    - name: âœ… Commit validation passed
      run: echo "âœ… All commit validation checks passed!"
